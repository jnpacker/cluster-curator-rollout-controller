# Example ClusterCuratorRollout demonstrating the new group/filter model
#
# NEW MODEL:
# - "group" is a branching point that must have "filter" children
# - "filter" adds label predicates; creates a Placement when it has no children (leaf)
# - Order of filter children defines rollout priority (no need for groupByPriorityOrder)
# - soakDuration on filter: wait after all filtered clusters complete before next sibling
# - concurrency.soakDuration: wait between each concurrent batch of clusters
#
# This example:
# 1. Groups clusters by the "region" label
# 2. Within each region, filters to only "clusterrole=production" clusters
#
# Expected Placements:
#   - my-rollout-region-us-clusterrole-production
#   - my-rollout-region-can-clusterrole-production
#   - my-rollout-region-eu-clusterrole-production
#
apiVersion: rollout.open-cluster-management.io/v1alpha1
kind: ClusterCuratorRollout
metadata:
  name: production-upgrade-4-15
  namespace: open-cluster-management
  labels:
    app.kubernetes.io/name: clustercuratorrollout
    app.kubernetes.io/part-of: cluster-curator-rollout-controller
spec:
  # Target OpenShift version for the upgrade
  openShiftVersion: "4.15.3"

  # Optionally, only upgrade clusters currently at one of these versions
  onlyUpgradeFromOpenShiftVersions:
    - "4.14"      # Matches all 4.14.x clusters

  # Top-level: group by region
  type: group
  groupByLabelKey: region

  children:
    # US region first (1st priority)
    - type: filter
      labelSelector:
        matchLabels:
          region: US
      soakDuration: 48h  # Wait 48h after US completes before CAN

      children:
        - type: filter
          labelSelector:
            matchLabels:
              clusterrole: production
          concurrency:
            type: percent
            value: 25  # Upgrade 25% of clusters concurrently

    # Canada region second (2nd priority)
    - type: filter
      labelSelector:
        matchLabels:
          region: CAN
      soakDuration: 24h  # Wait 24h after CAN completes before EU

      children:
        - type: filter
          labelSelector:
            matchLabels:
              clusterrole: production
          concurrency:
            type: percent
            value: 25

    # EU region last (3rd priority - no soak after)
    - type: filter
      labelSelector:
        matchLabels:
          region: EU
      # No soakDuration - last region

      children:
        - type: filter
          labelSelector:
            matchLabels:
              clusterrole: production
          concurrency:
            type: percent
            value: 25

---
# Simple example using a direct placement reference
apiVersion: rollout.open-cluster-management.io/v1alpha1
kind: ClusterCuratorRollout
metadata:
  name: simple-placement-rollout
  namespace: open-cluster-management
spec:
  openShiftVersion: "4.15.3"

  # Use an existing Placement resource
  type: placement
  placementRef:
    name: my-existing-placement
    namespace: open-cluster-management

---
# Example with filter -> filter (nested filters without group)
# This creates a single placement with combined predicates
apiVersion: rollout.open-cluster-management.io/v1alpha1
kind: ClusterCuratorRollout
metadata:
  name: nested-filter-rollout
  namespace: open-cluster-management
spec:
  openShiftVersion: "4.15.3"

  # First, filter to only production environment
  type: filter
  labelSelector:
    matchLabels:
      environment: production

  children:
    # Then filter to only us-east region
    - type: filter
      labelSelector:
        matchLabels:
          region: us-east
      concurrency:
        type: count
        value: 1  # One cluster at a time
        soakDuration: 1h  # Wait 1h between each cluster

# This creates a single Placement with predicates:
#   environment=production AND region=us-east
